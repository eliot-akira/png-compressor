<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNG Compressor</title>
  <script>
if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
  new EventSource('/esbuild').addEventListener('change', () => location.reload())
}
  </script>
  <style>
html, body {
  margin: 0;
}
body {
  padding: 1rem;
}
body, p, textarea, pre {
  font-size: 16px;
}
p {
  margin: 1rem 0;
}
.hidden {
  display: none;
}
.result {
  background-color: #eee;
  min-height: 3rem;
}
textarea, .result, .result-image {
  display: block;
  width: 100%;
  max-width: 36rem;
  padding: .5rem;
}

.result, #decode textarea {
  white-space: pre-wrap;
  word-break: break-all;
}

#encode .result,
#decode .result-image,
#encode-binary .result,
#decode-binary .result {
  max-width: 220px;
  image-rendering: pixelated;
}
.visually-hidden {
  position: absolute !important;
  height: 1px;
  width: 1px;
  overflow: hidden;
  clip: rect(1px, 1px, 1px, 1px);
}
input.visually-hidden:is(:focus, :focus-within) + label {
  outline: thin dotted;
}

</style>
</head>
<body>

  <h1>PNG Compressor</h1>

  <p><a href="api">API</a> · <a href="tests">Tests</a> · <a href="https://github.com/eliot-akira/png-compressor">Source code</a></p>

  <article>
    <section id=encode>

      <h1>Encode text</h1>

      <p><textarea class="input-text" cols=60 rows=10 autocomplete=off>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</textarea></p>

      <p>
      <button type=button class="button action-clear">Clear</button>
      <button type=button class="button action-download">Download image</button>
      </p>

      <h4>Result</h4>

      <div class=stats></div>
      <p><img class="result" /></p>

    </section>
    <hr>
    <section id=decode>

      <h1>Decode text</h1>

      <p>
        <input type=file id=input-image class="input-image visually-hidden" accept="image/png" />
        <button type=button><label for="input-image">
          Upload image
        </label></button>
        <button type=button class="button action-clear">Clear</button>
      </p>

      <h4>Result</h4>
      <p><pre class="result"></pre></p>

      <p><img class="result-image" /></p>

    </section>
    <hr>
    <section id=encode-binary>

      <h1>Encode binary</h1>

      <p>
        <input type=file id=encode-binary-input-image class="input-image visually-hidden" accept="*" />
        <button type=button><label for="encode-binary-input-image">
          Upload file
        </label></button>
        <button type=button class="button action-clear">Clear</button>
      </p>

      <h4>Result</h4>

      <div class=stats></div>
      <p><img class="result" /></p>
      <button type=button class="button action-download hidden">Download image</button>

    </section>
    <hr>
    <section id=decode-binary>

      <h1>Decode binary</h1>

      <p>
        <input type=file id=decode-binary-input-image class="input-image visually-hidden" accept="image/png" />
        <button type=button><label for="decode-binary-input-image">
          Upload image
        </label></button>
        <button type=button class="button action-clear">Clear</button>
      </p>

      <h4>Result</h4>

      <div class=stats></div>
      <p><img class="result" /></p>
      <button type=button class="button action-download hidden">Download decoded file</button>

    </section>
  </article>

  <script src=png-compressor.js></script>
  <script type=module>

const { encodeToBlob, decode, encodeBinary, decodeBinary } = PNGCompressor

const $encode = document.getElementById('encode')
const $encodeInput = $encode.querySelector('.input-text')
const $encodeResult = $encode.querySelector('.result')
const $encodeClearButton = $encode.querySelector('.action-clear')
const $encodeDownloadButton = $encode.querySelector('.action-download')

const $encodeStats = $encode.querySelector('.stats')

const $decode = document.getElementById('decode')
const $decodeInput = $decode.querySelector('.input-image')
const $decodeResult = $decode.querySelector('.result')
const $decodeResultImage = $decode.querySelector('.result-image')
const $decodeClearButton = $decode.querySelector('.action-clear')

let encodedBlob

encodeInput()

function encodeInput() {

  const value = $encodeInput.value

  let url

  encodeToBlob(value)
  .then(blob => {

    encodedBlob = blob

    // $encodeResult.innerText = encoded
    if (url) {
      URL.revokeObjectURL(url)
    }
    url = URL.createObjectURL(blob)

    $encodeResult.src = url

    const before = value.length
    const after = blob.size // encoded.byteLength
    
    if (!before) {
      $encodeStats.innerText = ''
    } else {
      const ratio = after / before
      $encodeStats.innerText = `Before: ${before} bytes · After: ${after} bytes · Compressed: ${(ratio * 100).toFixed(2)}%`
    }

    // Demonstrate that decode works
    decodeInput(encodedBlob)
  })
  .catch(error => {
    $encodeResult.innerText = error.message
    console.error(error)
  })
}

$encodeInput.addEventListener('keyup', function() {
  encodeInput()
})

$encodeClearButton.addEventListener('click', function() {
  $encodeInput.value = ''
  $encodeResult.src = ''
  $encodeStats.innerText = ''      

  $decodeInput.value = ''
  $decodeResult.innerText = ''
  $decodeResultImage.src = ''
})

$encodeDownloadButton.addEventListener('click', function() {
  if (!encodedBlob) return

  const blob = encodedBlob
  const url = URL.createObjectURL(blob)

  let a = document.createElement("a")
  a.download = 'compressed.png'
  a.href = url
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  a = null

  URL.revokeObjectURL(url)
})

// Decode

async function decodeInput(buffer) {
  if (!buffer) return

  const value = buffer instanceof Blob
    ? await buffer.arrayBuffer()
    : buffer

  try {

    $decodeResult.innerText = await decode(value)

  } catch(error) {
    $decodeResult.innerText = error.message
    console.error(error)  
  }
}

$decodeInput.addEventListener('change', function() {

  const file = this.files[0]

  const reader = new FileReader()
  reader.addEventListener('load', () => {

    const buffer = reader.result
    const blob = new Blob([ buffer ])
    const url = URL.createObjectURL(blob)

    $decodeResultImage.src = url

    URL.revokeObjectURL(url)

    decodeInput(blob)
  })

  reader.readAsArrayBuffer(file)
})

$decodeClearButton.addEventListener('click', function() {
  $decodeInput.value = ''
  $decodeResult.innerText = ''
  $decodeResultImage.src = ''
})

// Encode binary

const $encodeBinary = document.getElementById('encode-binary')
const $encodeBinaryInput = $encodeBinary.querySelector('.input-image')
const $encodeBinaryClearButton = $encodeBinary.querySelector('.action-clear')
const $encodeBinaryDownloadButton = $encodeBinary.querySelector('.action-download')
const $encodeBinaryResult = $encodeBinary.querySelector('.result')
const $encodeBinaryStats = $encodeBinary.querySelector('.stats')

let encodedBinaryBlob
let encodedBinaryBlobFileName

$encodeBinaryInput.addEventListener('change', function() {

  const file = this.files[0]

  const reader = new FileReader()

  reader.addEventListener('load', () => {

    const pngFileName = file.name + '.png'
    const buffer = reader.result

    console.log('Got file', file.name, buffer)

    encodeBinary(buffer)
    .then(encoded => {

      console.log('Encoded', encoded)

      const blob = new Blob([ encoded ])
      const url = URL.createObjectURL(blob)
      $encodeBinaryResult.src = url
      setTimeout(() => {
        URL.revokeObjectURL(url)
      }, 0)

      encodedBinaryBlob = blob
      encodedBinaryBlobFileName = pngFileName

      $encodeBinaryDownloadButton.classList.remove('hidden')

      const before = buffer.byteLength
      const after = encoded.byteLength
      
      if (!before) {
        $encodeBinaryStats.innerText = ''
      } else {
        const ratio = after / before
        $encodeBinaryStats.innerText = `Before: ${before} bytes · After: ${after} bytes · Compressed: ${(ratio * 100).toFixed(2)}%`
      }

    })
    .catch(e => {

      clearEncodedBinaryInterface()

      $encodeBinaryStats.innerText = `Error: ${e.message || 'Unknown'}`
      console.error(e)
    })

  })

  reader.readAsArrayBuffer(file)
})

function clearEncodedBinaryInterface() {
  $encodeBinaryInput.value = ''
  $encodeBinaryResult.src = ''
  $encodeBinaryStats.innerText = ''
  $encodeBinaryDownloadButton.classList.add('hidden')

  encodedBinaryBlob = null
  encodedBinaryBlobFileName = null
}

$encodeBinaryClearButton.addEventListener('click', function() {
  clearEncodedBinaryInterface()
})


$encodeBinaryDownloadButton.addEventListener('click', function() {
  if (!encodedBinaryBlob) return

  const blob = encodedBinaryBlob
  const url = URL.createObjectURL(blob)

  let a = document.createElement("a")
  a.download = encodedBinaryBlobFileName // 'compressed.png'
  a.href = url
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  a = null

  URL.revokeObjectURL(url)
})

// Decode binary

const $decodeBinary = document.getElementById('decode-binary')
const $decodeBinaryInput = $decodeBinary.querySelector('.input-image')
const $decodeBinaryResult = $decodeBinary.querySelector('.result')
const $decodeBinaryDownloadButton = $decodeBinary.querySelector('.action-download')
const $decodeBinaryClearButton = $decodeBinary.querySelector('.action-clear')
const $decodeBinaryStats = $decodeBinary.querySelector('.stats')

let decodedBinaryBlob
let decodedBinaryBlobFileName

$decodeBinaryInput.addEventListener('change', function() {

  const file = this.files[0]

  const reader = new FileReader()
  reader.addEventListener('load', () => {

    const buffer = reader.result
    const blob = new Blob([ buffer ])

    const url = URL.createObjectURL(blob)
    $decodeBinaryResult.src = url
    setTimeout(() => {
      URL.revokeObjectURL(url)
    }, 0)

    decodeBinary(buffer)
    .then(decoded => {

      decodedBinaryBlob = new Blob([ decoded ])
      decodedBinaryBlobFileName = file.name.replace(/\.png$/, '')

      $decodeBinaryStats.innerText = `Decoded ${decodedBinaryBlobFileName}`
      $decodeBinaryDownloadButton.classList.remove('hidden')
    })
    .catch(error => {

      clearDecodedBinaryInterface()

      $decodeBinaryStats.innerText = error.message
      console.error(error)  
    })

  })

  reader.readAsArrayBuffer(file)
})

function clearDecodedBinaryInterface() {
  $decodeBinaryInput.value = ''
  $decodeBinaryResult.src = ''
  $decodeBinaryStats.innerText = ''
  $decodeBinaryDownloadButton.classList.add('hidden')

  decodedBinaryBlob = null
  decodedBinaryBlobFileName = null
}

$decodeBinaryClearButton.addEventListener('click', function() {
  clearDecodedBinaryInterface()
})

$decodeBinaryDownloadButton.addEventListener('click', function() {
  if (!decodedBinaryBlob) return

  const blob = decodedBinaryBlob

  const url = URL.createObjectURL(blob)
  let a = document.createElement("a")
  a.download = decodedBinaryBlobFileName // 'compressed.png'
  a.href = url
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  a = null

  setTimeout(() => {
    URL.revokeObjectURL(url)
  }, 0)
})

</script>
</body>
</html>